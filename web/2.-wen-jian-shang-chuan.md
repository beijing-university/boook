# 2.文件上传

1.  文件上传：

    > 客户端->发文件->服务器接收->程序判断->临时文件->移动到指定的路径
2. 文件上传错误代码：
   1. 0：上传成功。没有错误
   2. 1：文件上传超过了upload. max.filesize的限制
   3. 2：文件的大小超过了html的max\_file\_size的选项
   4. 3：文件部分上传
   5. 4：文件没有被上传
3. 服务器（通常关键步骤的代码）：
   1. 判断文件接收码
   2. 处理文件
   3. 创建目录。放置
4. 网站文件常见后缀：
   1. asp
   2. asa
   3. cdx
   4. cer
   5. php
   6. aspx
   7. ashx
   8. php3
   9. php3
   10. php.a
   11. shtml
   12. phtml
   13. 被过滤时考虑以下：
   14. aspasp
   15. phpphp
5. 漏洞成因：
   1. 文件可以直接上传可执行脚本（文件名没做任何限制）
   2. 只在客户端js脚本限制
   3. 黑名单（不安全)
   4. 文件名可控（iis6.0解析漏洞、目录解析漏洞（文件夹为xx.asp 上传文件到这个文件夹就会解析））
      1. iis6.0解析漏洞：（源码）
         1. 白名单
         2. dir：如果上传失败就是一个upfile，成功就建一个filepath目录
         3.
6. 对应方式（上传的时候多试几种文件类型。gif、jpg、png等等，算是一种模糊测试)
   1. 直接上传脚本
   2. 绕过js脚本验证
      1. 修改前端元素的属性。删除验证的脚本
      2. 直接在form上加action="目的域名"
      3. post提交的时候，尝试把数据都不要了，直接加上代码（就不怕被影响解析）
      4. bp里改后缀名
   3. 黑白名单绕过：穷举后缀名
      1. 基础
         1. 黑：后缀名不允许上传的
         2. 白：允许上传的文件后缀。基本上绕不过，有一些可以
      2. 方法
         1. bp爆破：抓包，发送到repeator。增加变量。payload里导入字典。爆破
   4. 文件头检测突破：这种不知道是不是图片马
      1. 测试可以上传的文件头（jpg什么的）
      2. 通过linux cp 隐写恶意代码到白名单文件。（图片隐写）
         1. eg: cp 1.gif/b(/b是二进制模式的意思）+xx.php shell.php（生成shell.php文件）
   5. iis6.0：文件名可控。 后缀名不可控（后缀名是固定的）
      1. payload:xx.shell;.jpg。通过控制文件名来绕过。因为分号后面的部分iis解析的时候会自动截断。所以可以在绕过文件检测后保存xx.shell的文件格式到服务器。实现getshell
   6. 文件目录解析漏洞：只能用于iis6.0（%00截断的扩展）
      1. 条件：只能是asp文件
      2. 只要是文件为asp，都保存到asp这个文件夹里面。访问就会执行脚本
      3. payload：上传asp图片马（iis6.0后缀为jpg、gif是合法的。eg：asp一句话：<%eval request("z15us") %>。然后菜刀利用
      4. 看状态码 就知道马儿有没有事
   7. 使用%00截断：
      1. 截断文件名：可以通过%00断掉文件后面的字符
      2. 目录解析漏洞：
         1. 方法 bp抓包。在Params里（效果跟直接在原文改一样，就是方便）。改body的filepath（a.asp%00asp。%00后面加不加无所谓 )。然后回到原文把%00给decode。回显上传失败，但服务器端已经有了。可以用来绕过一些防火墙
         2. 其他技巧：html可以在form加input type为hidden value为要加的参数。使上传时候的文件名加上参数
      3. %00后上传可以在服务器生成一个文件
   8. 利用系统特性突破上传：突破服务器
      1. 基础：
         1. iis6.0.利用php和windows环境的特性，对正则匹配的特性：
            1. 双引号==点号
            2. 大于==问号
            3. 小于==星号
            4. 文件名.<<<或>>>(eg:在服务器有一个a.php空白。上传报文，报文filename=a.<<<,在主题里写入恶意代码,上传。会在服务器的空白文件写入代码
         2. NTFS交换数据流：可以用来绕过防火墙
            1. :$DATA 创建文件
               1. payload:a.php:$DATA
            2. ::$DATA 创建和写入文件
      2. 利用冒号或分号，可以在服务器生成一个文件:eg:a.php:.php。在服务器生成一个a.php
   9. 双文件：一个上传正常图片，一个上传恶意代码。有时候可以绕过
   10. 配置错误：
       1. payload:1.jpg/.php
       2. 原因：iis7.0、7.5。nginx开fast-cgi
   11. 漏洞：
       1. nginx 0.83:
          1. payload：、1.jpg%00php
   12. 9.10.11都很少见了，可以测试看看
       1. 在登录到一个页面后，复制图片，到火狐访问。后面加上x.php(如果存在漏洞，会返回错误信息）
   13. window系统会默认把最后一个点去掉。可以绕过一些防火墙（比如，payload:a……………..这样上传也可以哈哈哈哈）
7. 测试环境：
   1. window靶机：winwebmail server 3.9.0.7
      1. 网站->属性->应用程序配置->可执行文件（可自主设定可执行文件的本地后缀）
   2. 主机：设置host映射（靶机ip 网站域名）
